local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--// Settings
local Aimbot = {
    Enabled = true,
    Toggle = false,
    Running = false,
    Locked = nil,
    LockPart = "Head",
    LockMode = 1, 
    Sensitivity = 0.1,
    Sensitivity2 = 3.5,
    TriggerKey = Enum.KeyCode.R, -- Default to R
    TeamCheck = true,
    WallCheck = true,
    SwitchCooldown = 0.25,
}

local LastSwitch = 0

local function GetClosestTarget()
    local closest, closestDist = nil, math.huge

    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer or not player.Character then continue end

        local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
        local part = player.Character:FindFirstChild(Aimbot.LockPart)

        if not humanoid or not part or humanoid.Health <= 0 then continue end
        if Aimbot.TeamCheck and player.Team == LocalPlayer.Team then continue end

        if Aimbot.WallCheck then
            local ignore = {}
            for _, v in ipairs(LocalPlayer.Character:GetDescendants()) do table.insert(ignore, v) end
            for _, v in ipairs(player.Character:GetDescendants()) do table.insert(ignore, v) end
            if #Camera:GetPartsObscuringTarget({part.Position}, ignore) > 0 then continue end
        end

        local screenPos, visible = Camera:WorldToViewportPoint(part.Position)
        if not visible then continue end

        local distance = (UserInputService:GetMouseLocation() - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
        if distance < closestDist then
            closest = player
            closestDist = distance
        end
    end

    if closest and tick() - LastSwitch >= Aimbot.SwitchCooldown then
        Aimbot.Locked = closest
        LastSwitch = tick()
    end
end

local function AimAt()
    if not Aimbot.Enabled or not Aimbot.Running then return end

    GetClosestTarget()
    local target = Aimbot.Locked
    if not target or not target.Character then return end

    local char = target.Character
    local part = char:FindFirstChild(Aimbot.LockPart)
    local human = char:FindFirstChildOfClass("Humanoid")

    -- cancel lock if invalid
    if not part or not human or human.Health <= 0 then
        Aimbot.Locked = nil
        return
    end

    -- make sure we can see it
    local screenPos, visible = Camera:WorldToViewportPoint(part.Position)
    if not visible then return end

    -- bullet drop: only apply above ~40 studs
    local distance = (Camera.CFrame.Position - part.Position).Magnitude
    local drop = distance >= 40 and math.clamp(math.log10(distance - 30) * 1.25, 0, 6) or 0
    local aimPos = part.Position + Vector3.new(0, drop, 0)

    if Aimbot.LockMode == 2 then
        local mousePos = UserInputService:GetMouseLocation()
        local screen = Camera:WorldToViewportPoint(aimPos)
        mousemoverel((screen.X - mousePos.X) / Aimbot.Sensitivity2, (screen.Y - mousePos.Y) / Aimbot.Sensitivity2)
    else
        if Aimbot.Sensitivity > 0 then
            TweenService:Create(Camera, TweenInfo.new(Aimbot.Sensitivity), {
                CFrame = CFrame.new(Camera.CFrame.Position, aimPos)
            }):Play()
        else
            -- force camera look without changing delta sensitivity
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, aimPos)
        end
    end
end

UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Aimbot.TriggerKey then
        if Aimbot.Toggle then
            Aimbot.Running = not Aimbot.Running
            if not Aimbot.Running then Aimbot.Locked = nil end
        else
            Aimbot.Running = true
        end
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if Aimbot.Toggle then return end
    if input.KeyCode == Aimbot.TriggerKey then
        Aimbot.Running = false
        Aimbot.Locked = nil
    end
end)

RunService.RenderStepped:Connect(AimAt)
return Aimbot
